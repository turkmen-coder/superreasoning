# Prompt CI/CD â€” Regression testing gate for prompt changes.
# Triggers on PRs that modify prompt-related files.
# Runs contract validation, golden tests, adversarial tests, and judge gates.

name: Prompt Regression CI

on:
  pull_request:
    paths:
      - 'data/templates.ts'
      - 'data/datasetPrompts.ts'
      - 'data/notebookLmPrompts.ts'
      - 'services/optimizerPrompts.ts'
      - 'services/vibeCodingPrompts.ts'
      - '.prompts/**'

  workflow_dispatch:
    inputs:
      prompt_id:
        description: 'Specific prompt ID to test (optional, runs all if empty)'
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  prompt-regression:
    name: Prompt Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      SR_USE_DB_STORE: 'false'
      DISABLE_API_KEY_AUTH: 'true'
      NODE_ENV: ci

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run prompt regression suite
        run: npx tsx server/scripts/run-regression-ci.ts --ci --fail-on-regression
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload regression report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-report-${{ github.run_id }}
          path: reports/regression-*.json
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const glob = require('@actions/glob');
            const globber = await glob.create('reports/regression-*.json');
            const files = await globber.glob();

            if (files.length === 0) {
              return;
            }

            let summary = '## Prompt Regression Report\n\n';
            let hasFailures = false;

            for (const file of files) {
              try {
                const content = JSON.parse(fs.readFileSync(file, 'utf-8'));
                const passed = content.summary?.passed ?? 0;
                const failed = content.summary?.failed ?? 0;
                const total = passed + failed;
                const icon = failed > 0 ? ':x:' : ':white_check_mark:';

                if (failed > 0) hasFailures = true;

                summary += `${icon} **${content.promptId || 'Suite'}**: ${passed}/${total} passed\n`;

                if (content.failures && content.failures.length > 0) {
                  summary += '<details><summary>Failures</summary>\n\n';
                  for (const f of content.failures) {
                    summary += `- \`${f.testName}\`: ${f.message}\n`;
                  }
                  summary += '\n</details>\n\n';
                }
              } catch (e) {
                summary += `:warning: Could not parse ${file}\n`;
              }
            }

            summary += `\n---\n*Generated by Prompt CI/CD pipeline*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary,
            });
